```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
# knitr defaults
root.dir = rprojroot::find_root("remake.yml")
knitr::opts_knit$set(root.dir = root.dir)
knitr::opts_chunk$set(echo=FALSE, cache=FALSE)
options(knitr.table.format = "html") # default for table format

# Guidelines for writing report code
# - use tidyverse style and format: http://htmlpreview.github.io/?https://github.com/nicercode/2018_BEES_regression/blob/master/tidyverse.html
# - use kableExtra for styling: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# - use knitr chunck options: https://rmarkdown.rstudio.com/lesson-3.html

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, results="hide"}
library(knitr)
library(dplyr)

source("R/austraits.R")
source("R/support.R")
source("R/report_utils.R")
source("R/report_notetaker.R")
source("R/report_maps.R")

austraits <- readRDS("export/data/austraits.rds")
show_map <- TRUE

# This enables the report to run inside Rstudio interactively
# Otherwsie assum variable is already set in global environment
if(!exists("dataset_id"))
  dataset_id <- "Blackman_2014"

definitions <- austraits$definitions
data_study <- extract_dataset(austraits, dataset_id)
data_yaml <- read_yaml(sprintf("data/%s/metadata.yml", dataset_id))
metadata_study <- austraits$metadata[[dataset_id]]

knitr::opts_chunk$set(fig.cap='', fig.path = file.path(root.dir,"export/reports/figures", paste0(dataset_id,"_")))
# start notetaker device
questions <- start_notetaker()
new_question <- function(txt) {
  x <- questions(add_note, as_note(txt)) %>% print_notes(as_anchor=TRUE)
  writeLines(sprintf("<font size = '3' color='orange'>**Question:** %s</font>", paste0(x, collape="")))
}
```

```{r header, echo=FALSE, results="asis"}
# generate the heder matter for the markdown file
writeLines(sprintf(
"---
title: Report on the study **`%s`** within the `Austraits` data compilation
output:
  html_document:
    df_print: kable
    highlight: tango
    keep_md: yes
    smart: no
    theme: yeti
    toc: yes
    toc_depth: 3
    toc_float:
      collapsed: false
      smooth_scroll: true
editor_options:
  chunk_output_type: console
---
", dataset_id))
```

# Introduction 

## About Austraits

`Austraits` is an open-source compilation of trait data for Australian plant species. The traits we are considering are any structural or physiological variable that tends to vary widely among species; and has been collected across a moderate number of species. Many people collect trait data, and as such, data is spread across many sources, under a variety of formats and terms. The goal of the Austraits project is to combine all of these data fragments into a harmonised compilation, to be made publicly available.

Austraits is built from many different sources, here referred to as `studies` (so called because the sources are most-often individual scientific papers). Our data processing pipeline seeks to combine all of the different studies in a transparent and reproducible way.

Data from each study in Austraits is organised as follows:

- each study is defined by a key  called the `dataset_id`, comprising the first author and year of publication, e.g. `Falster_2003`.
- data for each `dataset_id` is organised into two files, within the folder `data\dataset_id\`:
  - `data.csv` contains the primary trait measurements, in either long or wide format
  - `metadata.yml` contains all the contextual data (or metadata) about the trait measurements.

(The `yml` file extension (pronounced "YAML") [is a type structured data file](https://en.wikipedia.org/wiki/YAML), that is both human and machine readable. The information in it appears under various labels, which are imported into Austraits. You can edit it any text editor, or also in Rstudio. Generally, yml is used in situations where a table does not suit because of variable lengths and or nested structures.)

In addition, the Austraits repository consists of configuration files defining the list of known species, the definitions for each trait and table, appropriate unit conversions. 

Full details on the data structure are given in the attached file `XXXX`.

## Purpose of this report

The Austraits compilation includes data from a study with dataset_id **"`r dataset_id`"**. This document describes the information we have on that study. 
This report gives both data contributors and Austraits compilers the opportunity to:

1. Verify that our understanding and handling of your data is correct
2. Provide any missing information about the data

For almost all studies, some of the information in the `metadata.yml` file is missing and we'd like your assistance in making this as complete as possible for future users.


Please double check the information under the headings `People`, `Citation`, and `Description` to ensure it is correct. Edit the appropriate sections in the `metadata.yml` file you have been sent if any corrections are required. In particular have we correctly identified your data as having been collected in the field, from a lab experiment, or from herbarium samples.

In addition, if, in the report below, we are missing data of sample sites, sampling strategy, or methods could you please add them to the `metadata.yml` file or send them to us in an alternative format. In particular,

Site data would hopefully include coordinates for `latitude` and `longitude`, and, where available, any additional variables, such as site soil data or climatic data, that have been collected. This information is not required but worth inclusion when available. For large compilations such as data from herbarium collections such data may not be available.

Sampling strategy is a field to indicate how sites were chosen and how individuals samples were chosen. If your data is collected from herbarium specimens, you could simply indicate which herbaria were sampled.

For each trait, we hope to know the `value type` (is the data point you submitted an `individual observation`, `mean`, `min`, `max`, etc), number of `replicates` that contributed to the data point submitted and the `methodology` used to collect the data. Currently, methods have been extracted from referenced manuscripts, but quite often the submitted dataset includes traits whose collection methods aren't described in the manuscript. 

- For `herbarium studies`, please specify which variables were measured on dried herbarium samples and which are derived from field observations. If you know the number of herbarium samples measured please enter it under replicates. Otherwise leave the words `unknown`.

- For all studies if the value for certain traits (such as plant height) was extracted from the literature, please fill in `published literature` as the method and the replicate field would be `.na`. 

- If a trait value was determined by `expert opinion`, such as the data collector made the decision that a plant was a shrub, the method would be `expert opinion` and the replicate field would be `.na`.


Additionally, as information was added to the `metadata.yml` file, the following questions specific to your data set arose: **"`r metadata_study$dataset$questions_for_author`"**

Send feedback to ....

# Study context

## People

The following people are listed as contacts for this study:

```{r, results='asis', echo=FALSE}
metadata_study$people %>%
  list_to_df() %>%
  rename_all("str_to_title") %>%
  my_kable_styling()
```

## Citation

Data from this study is recorded as coming from the following sources:

Primary citation:

```{r, results='asis', echo=FALSE}
metadata_study$source$primary %>%
  list1_to_df() %>%
  my_kable_styling()
```

```{r, results='asis', echo=FALSE}
if(!is.null(metadata_study$source$secondary)) {
  writeLines("Secondary citation:")
  metadata_study$source$primary %>%
    list_to_df() %>%
    my_kable_styling()
  }
```

## Description

The dataset includes `r nrow(data_study$data)` individual records from `r data_study$data$species_name %>% unique() %>% length()` species, with data included for the following `r data_study$data$trait_name %>% unique() %>% length()` traits (see below for details).

The description we have of the study is as follows:

```{r, results='asis', echo=FALSE}
metadata_study$dataset %>%
  list1_to_df() %>%
  my_kable_styling()
```

## Locations sampled

Data were collected at the following sites and locations:

```{r, results='asis', echo=FALSE, warning=FALSE}
site_main <- c("longitude (deg)","latitude (deg)", "description")
  data_study$context %>%
  filter(trait_name %in% site_main) %>%
  select(-dataset_id) %>%
  spread(trait_name, value) -> sites

if(nrow(sites) > 0 ) {
  sites <- sites %>%
  mutate(`latitude (deg)` =as.numeric(`latitude (deg)`),
         `longitude (deg)` =as.numeric(`longitude (deg)`)) %>%
  select(site_name, `latitude (deg)`, `longitude (deg)`)

  sites %>%
    my_kable_styling()
} else{
  writeLines("**NO SITE DATA AVAILABLE -- can you supply any?**")
}
```


```{r maps, eval= show_map, echo=FALSE, results='hide', warning=FALSE, message=FALSE, fig.keep="all"}
# Make a map of study sites using ggmap
set_ggmap_cache()

sites <- sites %>% filter(!is.na(`latitude (deg)`) & !is.na(`longitude (deg)`))

if(nrow(sites) > 0 ) {
  australia_box <- c(left=113.338953078, bottom=-43.6345972634, right=153.569469029, top=-10.6681857235)
  print(make_map(australia_box, sites))

  sites_box <-  c(left = min(sites$`longitude (deg)`), bottom = min(sites$`latitude (deg)`), right = max(sites$`longitude (deg)`), top = max(sites$`latitude (deg)`))
  print(make_map(sites_box, sites))
}
```

## Additional site data

The following variables have been recorded for the sites included in the study:

```{r, results='asis', echo=FALSE}

data_study$context %>%
  filter(!(trait_name %in% site_main)) %>%
  select(-dataset_id, -error) %>%
  spread(trait_name, value) -> context

if(nrow(context) > 0 ) {
  context %>%
    my_kable_styling()
} else{
  writeLines(
  c("No contextual site data available",
  new_question("Do you have any contextual data you can send us?"))
  )
}

```

# Trait measurements

The dataset includes `r data_study$data %>% nrow()` individual data points from `r data_study$data$species_name %>% unique() %>% length()` species, with data included for the following `r data_study$data$trait_name %>% unique() %>% length()` traits:

```{r summary_table, results='asis', echo=FALSE}
data_study$data %>%
  group_by(trait_name) %>%
    summarise(
        records = length(value),
        species = length(unique(species_name))
        ) %>%
  my_kable_styling()
```

**TO DO** -- what to look out for below.

```{r, results='asis', echo=FALSE}
new_question("Does this look correct?")
```

# Traits - Numerical


```{r numerical, results='asis', echo=FALSE, message=FALSE, warning=FALSE, fig.height=10, fig.width=10}
traits <- data_study$data$trait_name %>% unique() %>% sort()
traits_numeric <- traits[trait_is_numeric(traits, definitions)]

writeLines(ifelse(length(traits_numeric) == 0,
        "No numerical traits data are currently available in this dataset",
        "We have recorded the following traits with continuous numerical values in this dataset. Plots are shown comparing the distribution of values in your study to others in the dataset"))

for(trait in traits_numeric) {

  meta <- data_yaml$traits %>% list_to_df() %>% filter(trait_name == trait)

  data_trait_study <- data_study$data %>%
    filter(trait_name == trait) %>%
    mutate(value = as.numeric(value))

  data_trait_all <- austraits$data %>%
    filter(trait_name == trait) %>%
    mutate(value = as.numeric(value))

  # Adjust height of plot according number of rows?
  # n_study <- data_trait_all %>% dplyr::pull(dataset_id) %>% unique() %>% length()
  # figure_height <- 4 + max(12, (n_study/5))

  x <- c("", "",
    sprintf("## %s", definitions$traits$values[[trait]]$label),
    "",
    sprintf("We aligned the variable called `%s`in the data you supplied with the trait `%s` in the Austraits database.\n\nThe original variable was supplied with units `%s`; these were converted to our standard `%s`.\n\nThe contributed data has the following properties:", meta$var_in, trait, meta$unit_in, definitions$traits$values[[trait]]$units),
    "",
    sprintf("- **Standardised name**: %s", trait ),
    sprintf("- **Standardised description**: %s", definitions$traits$values[[trait]]$description ),
    sprintf("- **Records**: %s in this study (of %s in Austraits)", data_trait_study %>% nrow(), data_trait_all %>% nrow() ),
    sprintf("- **Allowable range**: %s - %s", definitions$traits$values[[trait]]$values$minimum,
            definitions$traits$values[[trait]]$values$maximum ),
    sprintf("- **Observed range in this study**: %s - %s", data_trait_study %>% dplyr::pull(value) %>% min(),
            data_trait_study %>% dplyr::pull(value) %>% max() ),
    "", "",
    "Data for this trait in this study were collected using the following methods:", "",
    sprintf("- **Value type**: %s", "**TODO XXXX**"),
    sprintf("- **Replicates**: %s", "**TODO XXXX**"),
    sprintf("- **Methods (from paper)**: %s", "**TODO XXXX**"), 
    "",
    "The following plot shows the distribution of recorded values for this trait in Austraits and separated by dataset, with your study highlighted in blue.",
    "")

  ## TODO: need a callout for when information is missing, collect as questions to past at end

  writeLines(x)

  trait_distribution_plot_numerical(austraits, trait, "dataset_id", highlight=dataset_id)
}
```

# Traits - Categorical

```{r categorical, results='asis', echo=FALSE, eval=TRUE}
## TODO for categorical variables, have a second plot with just the authors data that is rescaled, so they have a higher resolution along the y-axis
traits <- data_study$data$trait_name %>% unique() %>% sort()
traits_categorical <- traits[!trait_is_numeric(traits, definitions)]

writeLines(
  ifelse(length(traits_categorical) == 0,
    "No categorical traits data are currently available in this dataset.",
    "We have recorded the following traits with categorical values in this dataset. Plots are shown comparing the distribution of values in your study to others in the dataset"))

for(trait in traits_categorical) {

  meta <- data_yaml$traits %>% list_to_df() %>% filter(trait_name == trait)

  data_trait_study <- data_study$data %>%
    filter(trait_name == trait) %>%
    mutate(value = as.factor(value))

  data_trait_all <- austraits$data %>%
    filter(trait_name == trait) %>%
    mutate(value = as.factor(value))


  allowed <- names(definitions$traits$values[[trait]]$values)
  actual <- data_trait_study %>% dplyr::pull(value) %>% unique() %>% sort()

  x <- c("", "",
    sprintf("### %s", definitions$traits$values[[trait]]$label),
    "",
    sprintf("We aligned the variable called `%s`in the data you supplied with the trait `%s` in the Austraits database.\n\nThe contributed data has the following properties:", meta$var_in, trait),
    "",
    sprintf("- **Standardised name**: %s", trait ),
    sprintf("- **Standardised description**: %s", definitions$traits$values[[trait]]$description ),
    sprintf("- **Records**: %s in this study (of %s in Austraits)", data_trait_study %>% nrow(), data_trait_all %>% nrow() ),
    sprintf("- **Observed values**: %s of %s allowed values recorded -- %s", length(actual),length(allowed), actual %>% paste0(collapse=", ") %>% sort() ),
    sprintf("See the attached Appendix for definitions of the observed values to ensure we have assigned your data points that meaning you intended."),
    "",
    "The following plot shows distribution of recorded values for each dataset.",
    "")

  writeLines(x)

  trait_distribution_plot_categorical(austraits, trait, "dataset_id", highlight=dataset_id) %>% print()
}
```


# Species sample

We have records on the following species from your study. We have attempted to align species names with known taxonomic units, focussing primarily on the [`The Plant List` (TPL)](http://www.theplantlist.org/) -- a global working list of all known plant species. Shown in the table is 

- the original name supplied to us 
- alignment of your species with the [`The Plant List` (TPL)](http://www.theplantlist.org/)
- alignment of your species with the [`Australian Plant Census` (APC)](https://biodiversity.org.au/nsl/services/apc)
- alignment of your species with the [`Australian Plant Names Index` (APC_name_ID)](https://biodiversity.org.au/nsl/services/APNI)

Updated names are shown where different to the original name supplied, as well as links to the species records in those systems. Clicking on the links will take you to the relevant taxonomic record in each system for that species.

## Aligned taxonomy

```{r species_list, results='asis', echo=FALSE}
species <- data_study$data %>%
  select(original_name, species_name) %>%
  distinct() %>%
  arrange(original_name) %>%
  left_join(austraits$species_list, by ="species_name") %>% 
  rename(TPL_name = species_name) %>% 
  mutate(TPL_name = ifelse(TPL_name == original_name, "", TPL_name),
         APC_name = ifelse(APC_name == original_name, "", APC_name)
         )

species %>%
  mutate(
    TPL_ID = as_link_tpl(TPL_ID),
    APC_ID = as_link_apc(APC_ID),
    APNI_ID = as_link_apni(APNI_ID)
  ) %>%
  my_kable_styling() %>%
  kableExtra::column_spec(1, border_right = TRUE) %>%
  kableExtra::column_spec(6, border_right = TRUE) %>%
  kableExtra::column_spec(8, border_right = TRUE)

```

## Taxonomic corrections

In processing your data, we made the following substitution of names, with reasons as stated.

```{r species_subs, results='asis', echo=FALSE}
data_yaml$taxonomic_updates %>%
  list_to_df() %>%
  my_kable_styling()
```

**TO DO: Add TPL link to the above**

# The dataset

The full dataset provided by your study is as follows:

```{r all_data, eval=FALSE, results='asis', echo=FALSE}
data_study$data %>%
  select(-original_name) %>%
  my_kable_styling()
```

# 

# Questions

**Todo** Add list of general questions:

- were any of these data sourced from other studies?

<font size = '3' color='orange'>
```{r, results='asis', echo=FALSE}
questions() %>% print_notes() %>% writeLines()
```
</font>


# Session information

The technical information below may useful for us for the sake of reproduciblity, but you don't need to worry about it!

<font color='grey'>
This report was generated using the data from the commit `r get_SHA_link()`

And the following R environment

```{r, echo=FALSE}
sessionInfo()
```

</font>

