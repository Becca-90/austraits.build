```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
key <- data_study$key
definitions_traits_numeric <- subset(definitions_traits, type == "numeric")
# does dataset contain numeric data?
show_plot <- any(unique(data_study$data$trait_name) %in% definitions_traits_numeric$trait_name)
knitr::opts_chunk$set(echo=FALSE, fig.cap='', cache=FALSE)
```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE, eval=show_plot}
formatted <- format_data(data_study$key, data_study, austraits, definitions_traits_numeric) # format data for plotting
```

# Report for study: `r key`

##People

```{r, results='asis', echo=FALSE}
tab <- list_to_df(data_study$metadata$people)
kable(na.omit(tab), "markdown", align="l", padding=10)
```

##Data Source
Citation:data_study$metadata$source$primary$author, data_study$metadata$source$primary$year. data_study$metadata$source$primary$title data_study$metadata$source$primary$journal data_study$metadata$source$primary$volume: data_study$metadata$source$primary$pages

DOI: data_study$metadata$source$primary$doi

```{r, results='asis', echo=FALSE}

```

##Overview of data provided
The dataset provides data on data_study$metadata$dataset$description. It includes `r nrow(data_study$data)` individual datapoints from `r length(unique(data_study$data$species_name))` species, with data included for the following `r length(unique(data_study$data$trait_name))` traits: `r paste(unique(data_study$data$trait_name), collapse = ", ")`. Data collection began in the year data_study$metadata$dataset$year_collected_start and was completed in the year data_study$metadata$dataset$year_collected_end.

##Locations of data sites

The sites sampled are: 

xxx data table showing site names, lat, long, elev, including units, looping across sites in unique(data_study$context$site_name) and extracting data_study$context$trait_name=="longitude", data_study$context$trait_name=="latitude", data_study$context$trait_name=="elevation"  for each site
 
xxx if data_study$context$longitude does not exist, "location data is not available"

xxx question: are all sites in lat/long and meters elevation. If not, do we want to convert to this format?

xxx include map showing locations of the sites

#Data Available

##Physical site data
The following physical site data are available

temp <- subset(data_study$context$trait_name != c("longitude","latitude","elevation"))
table by site, using temp. The units used should be shown in a second header row. 

xxx we should do an automated check, to ensure that within each study's context file, units are consistent

xxx if the dataframe temp is empty, print "No additional physical site data is available for this study."

##Species sampled

The species sampled were:

xxx create a table of species, unique(data_study$data$taxon), with columns for each site
xxx place an x in columns for sites where a specific taxon was sampled

##Traits Sampled

xxx data table listing: trait names, trait units, number of species sampled, min, median, max values

xxx first create dataframe with unique entries from data_study$metadata$traits$var_in and data_study$metadata$traits$units_in

xxx then for the trait variables, summarise data from data_study$data to fill in number of species samples, min, median, max trait values

xxx question: in the data file, the traits and units are amalgamated. What is the easiest way to match with trait names generated from metadata yml file

xxx question: in the BAAD dataset, there are separate abbreviated trait names and longer labels. Do we have a lookup table with this information for austraits as well?

#Data summaries

```{r summary_table, results='asis', echo=FALSE}
tab <- summ(data_study$data)
kable(tab, "markdown", align="l", padding=10)
```

```{r, results='asis', echo=FALSE, eval = show_plot}
writeLines(sprintf("## Diagnostic plots of numeric data
### Pairwise plots for %s, log10 axes",key))
```

```{r pairwise_plots, fig.width=12, fig.height=9, echo=FALSE, message=FALSE, warning=FALSE, eval = show_plot}
pairwise_panel(key, formatted)
```

### Distributions of traits

xxx question: for these plots, should we have relevant data either as the top study or right in the middle?
```{r, include=FALSE, warning=FALSE, eval = show_plot}
# Make a list of traits
traits <- unique(data_study$data$trait_name[data_study$data$trait_name %in% definitions_traits_numeric$trait_name])
data_all <- austraits$data
src <- NULL

for(i in seq_along(traits)) {
  trait <- traits[i]

  # We're doing some tricks to rescale the plot height
  # We'll try to maintain constant density of points along yaxis and rescale plot height accordingly
  panel_ht_top <- 4
  target_density <- 5
  panel_ht_bottom <- max(2*panel_ht_top,
                        sqrt(nrow(data_all[data_all$trait_name==trait,]))/target_density)
  figure_height <- sum(panel_ht_top, panel_ht_top)

  ## This bit uses knitr's option to provide a template piece of code
  ## substitutes in values for anything inside {{}}
  src <- c(src, knit_expand(text=c(
        '#### {{trait}}\n',
        '```{r fig-{{trait}}, warning=FALSE, message=FALSE, fig.width=12, fig.height ={{figure_height}}}',
        'dotchart_single("{{trait}}", key, data_all, c({{panel_ht_top}}, {{panel_ht_bottom}}))',
        '```\n\n')))
}

# knit the source
res = knit_child(text = src)
```

```{r results='asis', eval = show_plot}
writeLines(res)
```

### Trait values with high associated intraspecific variation
If present, the table shows any trait records for species within the current dataset where the intraspecific variation across all records for this species-trait combination exceeds an order of magnitude. Note that the expected degree of intraspecific variation varies between traits.

```{r flags_table, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
flagged <- flags(key, austraits, definitions_traits_numeric)
if(nrow(flagged)>0)
  kable(flagged, "markdown", align="l", padding=10)
```

