```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
key <- data_study$key
definitions_traits_numeric <- subset(definitions_traits, type == "numeric")
# does dataset contain numeric data?
show_plot <- any(unique(data_study$data$trait_name) %in% definitions_traits_numeric$trait_name)
knitr::opts_chunk$set(echo=FALSE, fig.cap='', cache=FALSE)
```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE, eval=show_plot}
formatted <- format_data(data_study$key, data_study, austraits, definitions_traits_numeric) # format data for plotting
```

# Report for study: `r key`

## People

```{r, results='asis', echo=FALSE}
tab <- list_to_df(data_study$metadata$people)
kable(na.omit(tab), "markdown", align="l", padding=10)
```

## Overview of data provided

The dataset includes `r nrow(data_study$data)` individual datapoints from `r length(unique(data_study$data$species_name))` species, with data included for the following `r length(unique(data_study$data$trait_name))` traits: `r paste(unique(data_study$data$trait_name), collapse = ", ")`.

```{r summary_table, results='asis', echo=FALSE}
tab <- summ(data_study$data)
kable(tab, "markdown", align="l", padding=10)
```

```{r, results='asis', echo=FALSE, eval = show_plot}
writeLines(sprintf("## Diagnostic plots of numeric data
### Pairwise plots for %s, log10 axes",key))
```

```{r pairwise_plots, fig.width=12, fig.height=9, echo=FALSE, message=FALSE, warning=FALSE, eval = show_plot}
pairwise_panel(key, formatted)
```

```{r, results='asis', echo=FALSE, eval = show_plot}
writeLines("### Distributions of traits")
```

### Distributions of traits

```{r, include=FALSE, warning=FALSE, eval = show_plot}
# Make a list of traits
traits <- unique(data_study$data$trait_name[data_study$data$trait_name %in% definitions_traits_numeric$trait_name])
data_all <- austraits$data
src <- NULL

for(i in seq_along(traits)) {
  trait <- traits[i]

  # We're doing some tricks to rescale the plot height
  # We'll try to maintain constant density of points along yaxis and rescale plot height accordingly
  panel_ht_top <- 4
  target_density <- 5
  panel_ht_bottom <- max(2*panel_ht_top,
                        sqrt(nrow(data_all[data_all$trait_name==trait,]))/target_density)
  figure_height <- sum(panel_ht_top, panel_ht_top)

  ## This bit uses knitr's option to provide a template piece of code
  ## substitutes in values for anything inside {{}}
  src <- c(src, knit_expand(text=c(
        '#### {{trait}}\n',
        '```{r fig-{{trait}}, warning=FALSE, message=FALSE, fig.width=12, fig.height ={{figure_height}}}',
        'dotchart_single("{{trait}}", key, data_all, c({{panel_ht_top}}, {{panel_ht_bottom}}))',
        '```\n\n')))
}

# knit the source
res = knit_child(text = src)
```

```{r results='asis', eval = show_plot}
writeLines(res)
```

### Trait values with high associated intraspecific variation
If present, the table shows any trait records for species within the current dataset where the intraspecific variation across all records for this species-trait combination exceeds an order of magnitude. Note that the expected degree of intraspecific variation varies between traits.

```{r flags_table, results='asis', echo=FALSE, warning=FALSE, message=FALSE}
flagged <- flags(key, austraits, definitions_traits_numeric)
if(nrow(flagged)>0)
  kable(flagged, "markdown", align="l", padding=10)
```

