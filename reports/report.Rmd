```{r setup, echo=FALSE}
# knitr defaults
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_chunk$set(echo=FALSE, fig.cap='', cache=FALSE)

# default for table format
options(knitr.table.format = "html")

# Guidelines for writing report code
# - use tidyverse style and format: http://htmlpreview.github.io/?https://github.com/nicercode/2018_BEES_regression/blob/master/tidyverse.html
# - use kableExtra for styling: https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html
# - use knitr chunck options: https://rmarkdown.rstudio.com/lesson-3.html 
```

```{r, eval=TRUE, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
# This stuff enables report to run outside of remake framework. For development purposes only.
# Set eval=FALSE for use in remake environment  
library(knitr)
library(dplyr)
library(kableExtra)
source("R/support.R")
source("R/report.R")
austraits <- remake::make("austraits")
definitions_traits <- remake::make("definitions_traits")
data_study <- remake::make("Blackman_2014")
```
```{r,  echo=FALSE, results="hide", message=FALSE, warning=FALSE}
## default kable styling

table_styling <- function(...) {
  kable_styling(..., bootstrap_options = c("striped", "hover", "condensed", "responsive"), full_width = NULL, position = "center")
} 
```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE}
key <- data_study$key
definitions_traits_numeric <- definitions_traits %>% filter(type == "numeric")
# does dataset contain numeric data?
show_plot <- FALSE #any(unique(data_study$data$trait_name) %in% definitions_traits_numeric$trait_name)
```

```{r, echo=FALSE, results="hide", message=FALSE, warning=FALSE, eval=show_plot}
formatted <- format_data(data_study$key, data_study, austraits, definitions_traits_numeric) # format data for plotting
```
# Report for study: `r key`

## People

```{r, results='asis', echo=FALSE}
tab <- list_to_df(data_study$metadata$people)
kable(na.omit(tab)) %>% table_styling()
```

## Data Source
```{r, results='asis', echo=FALSE}
paste(data_study$metadata$source$primary$author,", ",data_study$metadata$source$primary$year,". ", data_study$metadata$source$primary$title," ",data_study$metadata$source$primary$journal," ", data_study$metadata$source$primary$volume,": ",data_study$metadata$source$primary$pages,sep="")

# if (data_study$metadata$source$primary$doi!=NULL) {
#   paste("DOI: ",data_study$metadata$source$primary$doi,sep="")
# }
```

##Overview of data provided
The dataset provides data on `r data_study$metadata$dataset$description`. It includes `r nrow(data_study$data)` individual datapoints from `r length(unique(data_study$data$species_name))` species, with data included for the following `r length(unique(data_study$data$trait_name))` traits: `r paste(unique(data_study$data$trait_name), collapse = ", ")`. Data collection began in the year `r data_study$metadata$dataset$year_collected_start` and was completed in the year `r data_study$metadata$dataset$year_collected_end`.

## Locations of data sites

The sites and locations sampled are: `r paste(unique(data_study$context$site_name), collapse = ",")`

```{r, results='asis', echo=FALSE}
  data_study$context %>% 
  filter(trait_name %in% c("longitude","latitude","elevation")) -> temp
  
  temp$trait_with_units <- paste(temp$trait_name," (",temp$unit,")",sep="")
  
  temp %>% 
  select(-unit, -dataset_id, -trait_name) %>%
  spread(trait_with_units, value) %>%
  kable(temp) %>% 
  table_styling()
```

**include map showing locations of the sites

# Data Available

##Physical site data
The following physical site variables have been collected:

The values for each site are:

  data_study$context %>% 
  filter(!(trait_name %in% c("longitude","latitude","elevation"))) -> temp
  
  temp$trait_with_units <- paste(temp$trait_name," (",temp$unit,")",sep="")
  
  temp %>% 
  select(-unit, -dataset_id, -trait_name) %>%
  spread(trait_with_units, value) %>%
  kable(temp) %>% 
  table_styling()

xxx we should do an automated check, to ensure that within each study's context file, units are consistent

xxx if the dataframe temp is empty, print "No additional physical site data is available for this study."

## Species sampled

The species sampled were:

xxx create a table of species, unique(data_study$data$taxon), with columns for each site
xxx place an x in columns for sites where a specific taxon was sampled

## Traits Sampled

xxx data table listing: trait names, trait units, number of species sampled, min, median, max values

xxx first create dataframe with unique entries from data_study$metadata$traits$var_in and data_study$metadata$traits$units_in

xxx then for the trait variables, summarise data from data_study$data to fill in number of species samples, min, median, max trait values

xxx question: in the data file, the traits and units are amalgamated. What is the easiest way to match with trait names generated from metadata yml file

xxx question: in the BAAD dataset, there are separate abbreviated trait names and longer labels. Do we have a lookup table with this information for austraits as well?

# Data summaries
The dataset includes `r nrow(data_study$data)` individual datapoints from `r length(unique(data_study$data$species_name))` species, with data included for the following `r length(unique(data_study$data$trait_name))` traits: 

```{r summary_table, results='asis', echo=FALSE}
tab <- summ(data_study$data)
kable(tab) %>% table_styling()
```

```{r, results='asis', echo=FALSE, eval = show_plot}
writeLines(sprintf("## Diagnostic plots of numeric data
### Pairwise plots for %s, log10 axes",key))
```

```{r pairwise_plots, eval= FALSE, fig.width=12, fig.height=9, echo=FALSE, message=FALSE, warning=FALSE, eval = show_plot}
pairwise_panel(key, formatted)
```

### Distributions of traits

xxx question: for these plots, should we have relevant data either as the top study or right in the middle?
```{r, include=FALSE, warning=FALSE, eval = show_plot}
# Make a list of traits
traits <- unique(data_study$data$trait_name[data_study$data$trait_name %in% definitions_traits_numeric$trait_name])
data_all <- austraits$data
src <- NULL

for(i in seq_along(traits)) {
  trait <- traits[i]

  # We're doing some tricks to rescale the plot height
  # We'll try to maintain constant density of points along yaxis and rescale plot height accordingly
  panel_ht_top <- 4
  target_density <- 5
  panel_ht_bottom <- max(2*panel_ht_top,
                        sqrt(nrow(data_all[data_all$trait_name==trait,]))/target_density)
  figure_height <- sum(panel_ht_top, panel_ht_top)

  ## This bit uses knitr's option to provide a template piece of code
  ## substitutes in values for anything inside {{}}
  src <- c(src, knit_expand(text=c(
        '#### {{trait}}\n',
        '```{r fig-{{trait}}, warning=FALSE, message=FALSE, fig.width=12, fig.height ={{figure_height}}}',
        'dotchart_single("{{trait}}", key, data_all, c({{panel_ht_top}}, {{panel_ht_bottom}}))',
        '```\n\n')))
}

# knit the source
res = knit_child(text = src)
```

```{r results='asis', eval = show_plot}
writeLines(res)
```

### Trait values with high associated intraspecific variation
If present, the table shows any trait records for species within the current dataset where the intraspecific variation across all records for this species-trait combination exceeds an order of magnitude. Note that the expected degree of intraspecific variation varies between traits.

```{r flags_table, results='asis', echo=FALSE, warning=FALSE, message=FALSE, eval = FALSE}
flagged <- flags(key, austraits, definitions_traits_numeric)
if(nrow(flagged)>0)
  kable(flagged) %>% table_styling()
```

